# scanned-pdf-to-md

> 扫描PDF转Markdown | 双源OCR交叉验证流水线

将扫描版PDF文档转换为高质量Markdown，采用双OCR源交叉验证策略，显著提升识别准确率。

---

## 为什么需要这个项目？

### 问题背景

将扫描版PDF（如历年真题、考试资料）转换为可编辑的Markdown时，单一OCR引擎存在以下问题：

| 问题 | 表现 |
|:---|:---|
| 识别误差 | 选项错位、文字识别错误、表格结构破损 |
| 水印干扰 | 培训机构水印混入正文（小象教育、抖音等） |
| 格式混乱 | 选项格式不统一（A.xxx vs A、xxx）、括号类型混用 |
| 内容缺失 | 部分选项或题目未被识别 |

**单一OCR的准确率约70-80%，无法直接用于生产环境。**

### 解决思路

不同OCR引擎各有优劣：

| OCR类型 | 优势 | 劣势 |
|:---|:---|:---|
| 通用OCR | 文字完整度高、题号识别稳定 | 表格结构差、选项可能连成一行 |
| 智能文档解析 | 表格识别优秀、选项换行准确 | 可能漏识部分文字 |

**核心洞察**：两个OCR源的错误通常不会出现在同一位置。

**解决方案**：双源交叉验证 —— 同时使用两个OCR引擎，逐题对比合并，取长补短。

---

## 设计思路

### 架构设计

```
                    ┌─────────────────┐
                    │   扫描版PDF      │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              ▼                              ▼
    ┌─────────────────┐            ┌─────────────────┐
    │   通用OCR        │            │  智能文档解析    │
    │   (火山引擎)     │            │  (火山引擎)      │
    │                 │            │                 │
    │ 输出：纯文本     │            │ 输出：结构化文档  │
    └────────┬────────┘            └────────┬────────┘
             │                              │
             ▼                              ▼
    ┌─────────────────┐            ┌─────────────────┐
    │ 纯OCR版.md       │            │ 文档解析版.md    │
    └────────┬────────┘            └────────┬────────┘
             │                              │
             └──────────────┬───────────────┘
                            ▼
              ┌───────────────────────────┐
              │    交叉验证（Claude Code）  │
              │                           │
              │  1. 逐题对比两个版本       │
              │  2. 合并生成完整内容       │
              │  3. 清除水印干扰          │
              │  4. 统一格式规范          │
              │  5. 生成验证报告          │
              └─────────────┬─────────────┘
                            ▼
              ┌───────────────────────────┐
              │      高质量Markdown        │
              │      (准确率 95%+)         │
              └───────────────────────────┘
```

### 核心原则

#### 1. 双源互补，不是二选一

```
错误做法：选择"更好"的那个版本
正确做法：合并两个版本，生成完整内容

示例：
- 纯OCR版第5题：A.xxx B.xxx C.xxx（缺D选项）
- 文档解析版第5题：A.xxx B.xxx C.xxx D.yyy
- 合并结果：A.xxx B.xxx C.xxx D.yyy ✓
```

#### 2. 逐套处理，不批量操作

**教训**：项目初期尝试批量处理20套题，发现后期套题格式问题明显增多。

**原因**：大批量处理时，AI容易"疲劳"，精度下降。

**解决**：改为逐套处理，每套完成后展示报告，用户确认后再继续。

#### 3. 铁律原则，防止AI发挥

| 铁律 | 说明 |
|:---|:---|
| 不发挥 | 只使用源文档中已有的内容 |
| 不编造 | 缺失内容标注 `[缺失]`，不猜测 |
| 不修改 | 只修复格式，不改动题目文字 |

#### 4. 验证报告，全程透明

每套题处理后生成报告，记录：
- 修复了什么（补齐选项、删除水印）
- 来源是哪个版本
- 有哪些待人工确认的内容

---

## 特性

- **双源交叉验证**：结合通用OCR和智能文档解析，互补优势
- **逐套验证模式**：避免批量处理精度下降，质量可控
- **自动格式标准化**：统一选项格式（A. xxx）、括号类型（中文括号）
- **干扰内容清除**：自动识别并删除水印、页码等干扰
- **验证报告生成**：透明记录所有修复操作，便于人工复核
- **Claude Code Skill**：一键启动 `/cross-validate-ocr`

---

## 适用场景

- 历年真题PDF转结构化题库
- 考试资料数字化
- 扫描版文档转Markdown
- 需要高准确率的OCR场景

---

## 快速开始

### 前置要求

- Python 3.8+
- Claude Code（Anthropic CLI工具）
- 火山引擎账号（OCR API）

### Step 1: 克隆项目

```bash
git clone https://github.com/your-username/scanned-pdf-to-md.git
cd scanned-pdf-to-md
pip install -r requirements.txt
```

### Step 2: 配置API密钥

```bash
cp scripts/config.example.py scripts/config.py
```

编辑 `scripts/config.py`，填入火山引擎API密钥：

```python
AK = "your_access_key"
SK = "your_secret_key"
```

### Step 3: 准备PDF图片

将PDF每页转换为PNG图片，放入 `PDF_image/` 目录：

```bash
# 使用 pdf2image 或其他工具
# 建议分辨率：300dpi
```

目录结构：
```
PDF_image/
├── page_001.png
├── page_002.png
├── page_003.png
└── ...
```

### Step 4: 执行双路OCR

```bash
# 路径A：通用OCR（文字完整度高）
python scripts/phase1_batch_ocr.py

# 路径B：智能文档解析（表格结构好）
python scripts/phase3_parse_tables.py
```

执行后生成：
- `output/公共营养师三级历年真题_纯OCR版.md`
- `output/公共营养师三级历年真题_文档解析版.md`

### Step 5: 交叉验证

在Claude Code中启动交叉验证：

```bash
claude
```

输入命令：
```
/cross-validate-ocr
```

按提示操作：
1. 系统识别所有套题（如20套）
2. 逐套处理，每套完成后展示验证报告
3. 确认后继续下一套
4. 全部完成后合并为最终文档

### Step 6: 获取输出

```
output/
├── validated/
│   ├── 01_2025-06_真题.md
│   ├── 02_2025-06_答案.md
│   └── ...
└── 公共营养师三级历年真题_验证版.md  # 合并后的完整文档
```

---

## 目录结构

```
scanned-pdf-to-md/
├── .claude/
│   └── skills/
│       └── cross-validate-ocr/
│           └── SKILL.md          # 交叉验证技能定义（核心）
├── PDF_image/                     # PDF提取的页面图片
├── output/
│   ├── raw_ocr/                   # 通用OCR原始结果（JSON）
│   ├── pdf_ocr/                   # 智能文档解析结果
│   ├── validated/                 # 验证后的分套题文件
│   └── *.md                       # 各版本Markdown文档
├── scripts/
│   ├── config.example.py          # 配置模板
│   ├── config.py                  # 实际配置（不提交）
│   ├── api.py                     # OCR API封装
│   ├── phase1_batch_ocr.py        # 批量通用OCR
│   ├── phase2_detect_tables.py    # 表格检测
│   ├── phase3_parse_tables.py     # 智能文档解析
│   └── phase5_merge_output.py     # 输出合并
├── docs/
│   └── SOP_OCR交叉验证流水线.md    # 完整SOP文档
├── reports/                       # 处理报告（JSON）
├── CLAUDE.md                      # Claude Code项目配置
└── README.md
```

---

## 工作原理详解

### 交叉验证流程

```
输入：纯OCR版.md + 文档解析版.md

对每套题执行：
│
├─ Step 1: 分割套题
│   使用正则匹配年份月份边界
│   如：2025年6月统考真题
│
├─ Step 2: 逐题合并
│   ├─ 题目文本：取更完整的版本
│   ├─ 选项A：对比两版，取有内容的
│   ├─ 选项B：对比两版，取有内容的
│   ├─ 选项C：对比两版，取有内容的
│   └─ 选项D：对比两版，取有内容的
│
├─ Step 3: 干扰清除
│   删除：小象教育、抖音、页码等
│
├─ Step 4: 格式标准化
│   ├─ 选项格式：A. xxx（字母+点+空格+内容）
│   ├─ 答案格式：1. 【答案】A
│   └─ 括号统一：使用中文（）
│
├─ Step 5: 生成验证报告
│   记录所有修复操作
│
└─ Step 6: 输出单套文件
    output/validated/XX_YYYY-MM_类型.md

最终：合并所有套题为完整文档
```

### 优先级规则

| 内容类型 | 优先采用 | 原因 |
|:---|:---|:---|
| 表格 | 文档解析版 | Markdown格式更好 |
| 选项文本 | 文档解析版 | 换行更准确 |
| 题目文本 | 对比取更完整的 | 两版各有优劣 |
| 题号 | 纯OCR版 | 识别更稳定 |

### 冲突处理

当两版内容明显不一致时：
```markdown
[待人工确认：版本A为xxx，版本B为yyy]
```
记录到验证报告，由人工最终判断。

---

## 验证报告示例

```markdown
# 2025年6月公共营养师三级统考真题

## 验证报告

### 统计
- 总题数：110（单选70 + 多选15 + 案例选择25）
- 修复项：12
- 待确认：0

### 修复记录
1. 第5题：补齐选项D（来源：纯OCR版）
2. 第12题：删除干扰内容"小象教育"
3. 第23题：修复括号配对
4. 第45题：统一选项格式 A.xxx → A. xxx
5. 第67题：从文档解析版补齐选项B

### 待人工确认
（无）

---

## 正文内容

一、单项选择题（第1～70题，每题1分，共70题）

1. 题目内容（）
A. 选项A
B. 选项B
C. 选项C
D. 选项D

...
```

---

## 自定义配置

### 修改干扰内容清单

编辑 `.claude/skills/cross-validate-ocr/SKILL.md`：

```markdown
#### 2.4 干扰内容清除
必须删除的干扰内容：
- `小象教育`
- `抖音`
- `你的自定义水印`
```

### 调整格式规范

根据你的文档格式要求，修改Skill文件中的格式规范部分。

### 修改题目结构

如果你的文档不是试题类型，可以调整分割正则和验证规则。

---

## 迭代经验

### 踩过的坑

| 问题 | 原因 | 解决方案 |
|:---|:---|:---|
| 后期套题格式混乱 | 批量处理20套，精度下降 | 改为逐套处理 |
| 水印混入正文 | 未建立干扰内容清单 | 维护干扰关键词列表 |
| 选项格式不统一 | 未定义标准格式 | 增加格式标准化步骤 |
| 内容顺序错乱 | 套题边界识别错误 | 用grep定位源文件行号 |

### 成功因素

1. **双源互补** > 单源优化
2. **逐套处理** > 批量处理
3. **铁律原则** > 让AI自由发挥
4. **验证报告** > 黑盒处理

---

## 技术栈

| 组件 | 技术 |
|:---|:---|
| OCR服务 | 火山引擎（通用OCR + 智能文档解析） |
| 交叉验证 | Claude Code + Custom Skill |
| 脚本语言 | Python 3.8+ |
| 输出格式 | Markdown / JSON / Word |

---

## 文档

- [完整SOP文档](docs/SOP_OCR交叉验证流水线.md) - 详细操作流程
- [Skill定义](.claude/skills/cross-validate-ocr/SKILL.md) - 交叉验证规则
- [项目配置](CLAUDE.md) - Claude Code配置

---

## 常见问题

### Q: 为什么不直接用更好的OCR引擎？

A: 没有"完美"的OCR引擎。不同引擎在不同内容上各有优劣，交叉验证是目前最可靠的提升准确率方案。

### Q: 可以用其他OCR服务吗？

A: 可以。只需修改 `scripts/api.py` 中的API调用，保持输出格式一致即可。推荐使用两个不同技术路线的OCR服务。

### Q: 处理非试题类文档可以吗？

A: 可以。需要修改 `.claude/skills/cross-validate-ocr/SKILL.md` 中的分割规则和验证逻辑。

### Q: 为什么要用Claude Code而不是纯Python？

A: 交叉验证需要理解语义、判断内容完整性、处理边界情况。这些任务LLM比硬编码规则更灵活准确。

---

## 许可证

MIT License

---

## 贡献

欢迎提交Issue和Pull Request。

改进方向：
- 支持更多OCR服务（百度、腾讯、阿里等）
- 增加Web界面
- 支持更多文档类型

---

## 致谢

- [火山引擎](https://www.volcengine.com/) - OCR服务
- [Claude Code](https://claude.ai/claude-code) by Anthropic - AI处理框架

---

*Made with Claude Code*
