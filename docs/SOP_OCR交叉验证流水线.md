# scanned-pdf-to-md | OCR交叉验证流水线 - 完整SOP文档

> 版本：1.0
> 创建日期：2024-12-30
> 项目名称：scanned-pdf-to-md
> 适用场景：扫描版PDF文档转Markdown，支持试题、文档等多种场景

---

## 一、项目概述

### 1.1 项目背景

将公共营养师三级历年真题PDF（371页）转换为结构化题库，支持JSON/Markdown/Word多格式输出。由于单一OCR引擎存在识别误差，采用**双源交叉验证**策略提升准确率。

### 1.2 核心挑战

| 挑战 | 具体表现 |
|:---|:---|
| OCR识别误差 | 选项错位、文字识别错误、表格破损 |
| 水印干扰 | 培训机构水印（小象教育、小鱼教育、抖音等） |
| 格式不统一 | 选项格式混乱、括号类型不一致 |
| 内容缺失 | 单一OCR源可能漏识部分内容 |

### 1.3 解决方案

采用**双OCR源交叉验证**架构：
- **纯OCR版**：火山引擎通用OCR API，文字识别完整度高
- **文档解析版**：火山引擎智能文档解析API，表格和格式识别优秀

两个版本互补，通过逐题对比合并，生成高质量验证版本。

---

## 二、技术架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        PDF源文件（371页）                         │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 1: PDF图片提取                          │
│                    (每页转换为PNG图片)                            │
└─────────────────────────────────────────────────────────────────┘
                                 │
                 ┌───────────────┴───────────────┐
                 ▼                               ▼
┌────────────────────────────┐   ┌────────────────────────────────┐
│   路径A: 通用OCR识别        │   │   路径B: 智能文档解析           │
│   (火山引擎 OCR API)        │   │   (火山引擎 Document Parser)    │
│                            │   │                                │
│   优势：                    │   │   优势：                        │
│   - 文字识别完整度高        │   │   - 表格结构识别优秀            │
│   - 题号识别稳定            │   │   - 选项换行准确                │
└────────────────────────────┘   └────────────────────────────────┘
                 │                               │
                 ▼                               ▼
┌────────────────────────────┐   ┌────────────────────────────────┐
│  公共营养师三级历年真题      │   │  公共营养师三级历年真题          │
│  _纯OCR版.md               │   │  _文档解析版.md                  │
└────────────────────────────┘   └────────────────────────────────┘
                 │                               │
                 └───────────────┬───────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Phase 2: 交叉验证处理                            │
│                  (Claude Code + Skill)                           │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ 1. 分割套题（按年份月份识别边界）                          │   │
│   │ 2. 逐套验证（对比两个版本，合并内容）                      │   │
│   │ 3. 格式标准化（选项格式、括号统一）                        │   │
│   │ 4. 干扰清除（水印、页码删除）                             │   │
│   │ 5. 生成验证报告                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                       输出文件                                    │
│                                                                 │
│   output/validated/                                             │
│   ├── 01_2025-06_真题.md                                        │
│   ├── 02_2025-06_答案.md                                        │
│   ├── ...                                                       │
│   └── 20_2022-03_答案.md                                        │
│                                                                 │
│   output/公共营养师三级历年真题_验证版.md  (合并版)                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
scanned-pdf-to-md/
├── .claude/
│   └── skills/
│       └── cross-validate-ocr/
│           └── SKILL.md          # 交叉验证技能定义
├── PDF_image/                     # PDF提取的页面图片（371张）
├── output/
│   ├── raw_ocr/                   # 通用OCR原始结果（JSON）
│   ├── pdf_ocr/                   # 智能文档解析结果
│   ├── validated/                 # 交叉验证后的分套题文件（20个）
│   ├── 公共营养师三级历年真题_纯OCR版.md
│   ├── 公共营养师三级历年真题_文档解析版.md
│   └── 公共营养师三级历年真题_验证版.md
├── scripts/
│   ├── config.py                  # API配置（AK/SK）
│   ├── api.py                     # OCR API封装
│   ├── phase1_batch_ocr.py        # 批量OCR处理
│   ├── phase2_detect_tables.py    # 表格检测
│   ├── phase3_parse_tables.py     # 表格解析
│   ├── phase5_merge_output.py     # 输出合并
│   ├── generate_standard_md.py    # Markdown生成
│   ├── generate_word.py           # Word文档生成
│   └── merge_final.py             # 最终合并脚本
├── reports/                       # 处理报告（JSON）
└── CLAUDE.md                      # 项目说明
```

### 2.3 API配置

使用火山引擎OCR服务，配置文件位于 `scripts/config.py`：

```python
# 火山引擎 AK/SK
VOLC_AK = "your_access_key"
VOLC_SK = "your_secret_key"

# OCR API端点
OCR_ENDPOINT = "visual.volcengineapi.com"
```

---

## 三、完整工作流程

### 3.1 Phase 1: PDF预处理

**目标**：将PDF转换为图片，便于OCR处理

**执行步骤**：
1. 使用 `pdf2image` 或类似工具将PDF每页转为PNG
2. 输出到 `PDF_image/` 目录
3. 命名规则：`三级历年真题及解析_XX.png`（XX为页码）

**验收标准**：
- 371张PNG图片
- 分辨率足够OCR识别（建议300dpi）
- 无缺页、无损坏

### 3.2 Phase 2: 双路OCR处理

#### 3.2.1 路径A：通用OCR

**执行脚本**：`scripts/phase1_batch_ocr.py`

**处理流程**：
1. 遍历所有PNG图片
2. 调用火山引擎通用OCR API
3. 保存识别结果到 `output/raw_ocr/`
4. 合并生成 `公共营养师三级历年真题_纯OCR版.md`

#### 3.2.2 路径B：智能文档解析

**执行脚本**：`scripts/phase3_parse_tables.py`

**处理流程**：
1. 调用火山引擎智能文档解析API
2. 保存解析结果到 `output/pdf_ocr/`
3. 合并生成 `公共营养师三级历年真题_文档解析版.md`

### 3.3 Phase 3: 交叉验证（核心流程）

**触发方式**：在Claude Code中输入 `/cross-validate-ocr`

**执行步骤**：

#### Step 1: 分割套题

使用正则表达式识别每套考试的边界：
```regex
(20\d{2})\s*年\s*(\d+)\s*月.*?(?:公共营养师|统考|真题)
```

本项目共识别出20套文件：
- 10套真题（2025年6月 ~ 2022年3月）
- 10套答案解析

#### Step 2: 逐套交叉验证

**重要原则**：必须一套一套处理，不能批量处理！

对每套题执行以下检查：

| 检查项 | 操作 |
|:---|:---|
| 题目完整性 | 对比两版，合并为完整题目 |
| 选项完整性 | 补齐缺失的ABCD选项 |
| 干扰内容 | 删除水印、页码等 |
| 格式规范 | 统一选项格式、括号类型 |
| 括号配对 | 检测并修复单边括号 |

#### Step 3: 格式标准化

**选项格式规范**：
```
正确格式：A. 选项内容
错误格式：A.选项内容（缺空格）
错误格式：A、选项内容（错误分隔符）
```

**答案格式规范**：
```
正确格式：1. 【答案】A
错误格式：1.【答案】A（缺空格）
```

**括号规范**：
- 统一使用中文括号（）
- 不使用英文括号()

#### Step 4: 干扰内容清除

必须删除的内容：
- `小象教育`
- `小鱼教育`
- `小东教育`
- `抖音`
- `douyin`
- `www.`
- `http`
- 单独成行的数字页码
- 明显的水印文字

#### Step 5: 生成验证报告

每套题处理完成后生成报告：

```markdown
# 2025年6月公共营养师三级统考真题

## 验证报告

### 统计
- 总题数：110（单选70 + 多选15 + 案例选择25）
- 修复项：12
- 待确认：0

### 修复记录
1. 第5题：补齐选项D（来源：纯OCR版）
2. 第12题：删除干扰内容"小象教育"
3. 第23题：修复括号配对
4. 第45题：统一选项格式

### 待人工确认
（无）

---

## 正文内容
...
```

### 3.4 Phase 4: 输出合并

**输出文件**：
- 分套文件：`output/validated/XX_YYYY-MM_类型.md`
- 合并文件：`output/公共营养师三级历年真题_验证版.md`

**合并命令**：
```bash
cat output/validated/*.md > output/公共营养师三级历年真题_验证版.md
```

---

## 四、考试结构标准

### 4.1 标准题量

每套完整试题应包含：

| 题型 | 题量 | 题号范围 |
|:---|:---|:---|
| 单项选择题 | 70题 | 1-70 |
| 多项选择题 | 15题 | 71-85 |
| 案例选择题 | 25题 | 86-110 |
| **合计** | **110题** | - |

### 4.2 特殊情况处理

部分年份试题结构可能不同：

| 年份 | 实际情况 | 处理方式 |
|:---|:---|:---|
| 2024年3月 | 单选仅56题 | 在报告中标注，按实际内容处理 |

---

## 五、验证规则（铁律）

### 5.1 核心原则

1. **不发挥、不编造**：只使用两个MD文档中已有的内容
2. **不猜测答案**：如果两版都没有某内容，标注 `[缺失]` 而不是编造
3. **保留原文**：修复格式问题，但不修改题目文字本身

### 5.2 优先级规则

| 内容类型 | 优先采用 | 原因 |
|:---|:---|:---|
| 表格 | 文档解析版 | Markdown格式更好 |
| 选项文本 | 文档解析版 | 换行更准确 |
| 题目文本 | 对比取更完整的 | 两版各有优劣 |
| 题号 | 纯OCR版 | 识别更稳定 |

### 5.3 冲突处理

当两版内容明显不一致时：
```markdown
[待人工确认：版本A为xxx，版本B为yyy]
```

---

## 六、成功因素分析

### 6.1 架构设计成功点

1. **双源互补策略**
   - 纯OCR版擅长文字完整度
   - 文档解析版擅长结构识别
   - 两者结合覆盖90%以上的OCR错误

2. **逐套处理模式**
   - 避免大批量处理时的精度下降
   - 每套独立验证，问题可追溯
   - 用户可逐套确认，质量可控

3. **验证报告机制**
   - 修复记录透明
   - 待确认项明确标注
   - 便于人工复核

### 6.2 Skill设计成功点

1. **明确的输入输出定义**
   - 输入文件路径固定
   - 输出文件命名规范统一

2. **详细的处理流程**
   - 每个步骤有明确的操作说明
   - 优先级规则清晰

3. **严格的验证规则**
   - 铁律原则防止AI"发挥"
   - 冲突处理有明确标准

### 6.3 迭代优化经验

| 问题 | 解决方案 |
|:---|:---|
| 批量处理精度下降 | 改为逐套处理 |
| 格式不统一 | 增加格式标准化规则 |
| 水印残留 | 建立干扰内容清单 |
| 内容顺序错乱 | 使用grep定位源文件边界 |

---

## 七、常见问题与解决方案

### 7.1 格式问题

**问题**：选项格式不统一（A.xxx vs A. xxx）

**解决**：在验证过程中统一替换为 `A. xxx` 格式

### 7.2 内容缺失

**问题**：某版本缺少部分选项

**解决**：从另一版本补齐，在报告中记录来源

### 7.3 精度问题

**问题**：大量数据处理时精度下降

**解决**：
- 采用逐套处理模式
- 每套处理后展示报告等待确认
- 使用grep定位源文件边界，避免跨套混淆

### 7.4 水印干扰

**问题**：OCR识别出水印文字

**解决**：建立干扰内容清单，在验证时自动删除

---

## 八、文件命名规范

### 8.1 分套文件命名

格式：`XX_YYYY-MM_类型.md`

| 字段 | 说明 | 示例 |
|:---|:---|:---|
| XX | 序号（01-20） | 01, 02, ... |
| YYYY | 年份 | 2025, 2024 |
| MM | 月份 | 06, 03, 09, 12 |
| 类型 | 真题/答案 | 真题, 答案 |

**示例**：
- `01_2025-06_真题.md`
- `02_2025-06_答案.md`
- `11_2024-03_真题.md`

### 8.2 合并文件命名

- `公共营养师三级历年真题_纯OCR版.md`
- `公共营养师三级历年真题_文档解析版.md`
- `公共营养师三级历年真题_验证版.md`

---

## 九、使用指南

### 9.1 快速开始

1. **准备源文件**
   - 将PDF转换为PNG图片放入 `PDF_image/`
   - 配置 `scripts/config.py` 中的API密钥

2. **执行OCR处理**
   ```bash
   python scripts/phase1_batch_ocr.py    # 通用OCR
   python scripts/phase3_parse_tables.py  # 文档解析
   ```

3. **执行交叉验证**
   - 在Claude Code中输入 `/cross-validate-ocr`
   - 按提示逐套确认

4. **检查输出**
   - 分套文件：`output/validated/`
   - 合并文件：`output/公共营养师三级历年真题_验证版.md`

### 9.2 自定义配置

**修改干扰内容清单**：

编辑 `.claude/skills/cross-validate-ocr/SKILL.md` 中的干扰内容列表：

```markdown
#### 2.4 干扰内容清除
必须删除的干扰内容：
- `小象教育`
- `抖音`
- [添加新的干扰内容...]
```

**修改格式规范**：

根据实际需求调整选项格式、括号规范等。

---

## 十、优化建议

### 10.1 当前版本限制

1. **人工介入需求**
   - 每套题需要人工确认
   - 待确认项需要人工判断

2. **特殊结构支持**
   - 当前针对公共营养师试题结构优化
   - 其他考试类型可能需要调整

### 10.2 未来优化方向

1. **自动化增强**
   - 增加自动格式检测
   - 建立更完善的干扰内容库

2. **通用性扩展**
   - 支持自定义题目结构
   - 支持更多考试类型

3. **质量评估**
   - 增加OCR置信度评估
   - 自动标记低置信度内容

---

## 十一、开源发布清单

### 11.1 必需文件

- [ ] `.claude/skills/cross-validate-ocr/SKILL.md`
- [ ] `scripts/*.py`（所有处理脚本）
- [ ] `CLAUDE.md`（项目说明）
- [ ] `README.md`（开源项目说明）
- [ ] `LICENSE`
- [ ] 本SOP文档

### 11.2 建议排除

- [ ] `PDF_image/`（原始图片，体积大）
- [ ] `output/`（输出结果，用户自行生成）
- [ ] `scripts/config.py`（包含API密钥）
- [ ] `.git/`

### 11.3 配置模板

创建 `scripts/config.example.py`：

```python
# 火山引擎 AK/SK（请替换为你的密钥）
VOLC_AK = "your_access_key_here"
VOLC_SK = "your_secret_key_here"

# OCR API端点
OCR_ENDPOINT = "visual.volcengineapi.com"
```

---

## 附录A：项目发展历程

### A.1 初始阶段
- 方案讨论：确定双OCR源交叉验证策略
- 技术选型：选择火山引擎OCR服务
- 架构设计：设计分阶段处理流程

### A.2 开发阶段
- Phase 1-3：完成OCR处理脚本开发
- Skill开发：创建 `/cross-validate-ocr` 技能
- 首轮验证：处理20套题（Sets 1-20）

### A.3 优化阶段
- 问题发现：2024年3月~2022年3月套题存在格式问题
- 根因分析：批量处理导致精度下降
- 解决方案：改为逐套处理，增加格式审核
- 二次验证：重新处理Sets 11-20

### A.4 成品阶段
- 格式审计：全面检查20套文件格式
- 问题修复：修正空格缺失等细节问题
- SOP文档：整理完整开发流程

---

## 附录B：验证报告模板

```markdown
# [年份]年[月份]月公共营养师三级[真题/答案解析]

## 验证报告

### 统计
- 总题数：XX（单选XX + 多选XX + 案例选择XX）
- 修复项：XX
- 待确认：XX

### 修复记录
1. 第X题：[修复内容]（来源：[版本]）
2. ...

### 待人工确认
1. 第X题：[问题描述]
   - 纯OCR版：xxx
   - 文档解析版：yyy

---

## 正文内容

[验证后的完整题目内容...]
```

---

## 附录C：干扰内容清单

| 类型 | 内容 | 备注 |
|:---|:---|:---|
| 培训机构 | 小象教育 | 水印 |
| 培训机构 | 小鱼教育 | 水印 |
| 培训机构 | 小东教育 | 水印 |
| 平台 | 抖音 | 水印 |
| 平台 | douyin | 水印URL |
| 网址 | www. | 干扰链接 |
| 网址 | http | 干扰链接 |
| 页码 | 纯数字行 | 页码残留 |

---

*文档版本：1.0*
*最后更新：2024-12-30*
*维护者：PDF_OCR_json项目组*
